#!/usr/bin/env python3
"""
CLOUD EXPLOITS - AWS/Azure/GCP Cloud Security Testing
Authority Level: 9.9
"""

import subprocess
import json
from typing import Dict, List
import logging

logger = logging.getLogger(__name__)

class CloudExploits:
    """Cloud security testing framework"""
    
    def __init__(self):
        self.aws_available = self._check_aws_cli()
        self.azure_available = self._check_azure_cli()
        self.gcp_available = self._check_gcloud_cli()
    
    def _check_aws_cli(self) -> bool:
        try:
            result = subprocess.run(['aws', '--version'], capture_output=True, timeout=5)
            return result.returncode == 0
        except:
            return False
    
    def _check_azure_cli(self) -> bool:
        try:
            result = subprocess.run(['az', '--version'], capture_output=True, timeout=5)
            return result.returncode == 0
        except:
            return False
    
    def _check_gcloud_cli(self) -> bool:
        try:
            result = subprocess.run(['gcloud', '--version'], capture_output=True, timeout=5)
            return result.returncode == 0
        except:
            return False
    
    def aws_enumerate_s3(self) -> Dict:
        """Enumerate S3 buckets"""
        if not self.aws_available:
            return {'status': 'error', 'error': 'AWS CLI not installed'}
        
        try:
            result = subprocess.run(
                ['aws', 's3', 'ls'],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            buckets = []
            for line in result.stdout.split('\n'):
                if line.strip():
                    buckets.append(line.strip())
            
            return {'status': 'success', 'buckets': buckets}
        except Exception as e:
            return {'status': 'error', 'error': str(e)}
    
    def aws_check_public_buckets(self) -> Dict:
        """Check for publicly accessible S3 buckets"""
        result = self.aws_enumerate_s3()
        if result['status'] != 'success':
            return result
        
        public_buckets = []
        for bucket in result.get('buckets', []):
            # Extract bucket name
            bucket_name = bucket.split()[-1] if bucket else None
            if bucket_name:
                # Check ACL
                try:
                    acl_result = subprocess.run(
                        ['aws', 's3api', 'get-bucket-acl', '--bucket', bucket_name],
                        capture_output=True,
                        text=True,
                        timeout=10
                    )
                    
                    if 'AllUsers' in acl_result.stdout or 'public' in acl_result.stdout.lower():
                        public_buckets.append(bucket_name)
                except:
                    pass
        
        return {
            'status': 'success',
            'public_buckets': public_buckets,
            'warning': len(public_buckets) > 0
        }
    
    def azure_enumerate_resources(self) -> Dict:
        """Enumerate Azure resources"""
        if not self.azure_available:
            return {'status': 'error', 'error': 'Azure CLI not installed'}
        
        try:
            result = subprocess.run(
                ['az', 'resource', 'list', '--output', 'json'],
                capture_output=True,
                text=True,
                timeout=60
            )
            
            resources = json.loads(result.stdout) if result.stdout else []
            return {'status': 'success', 'resources': resources, 'count': len(resources)}
        except Exception as e:
            return {'status': 'error', 'error': str(e)}
    
    def gcp_enumerate_projects(self) -> Dict:
        """Enumerate GCP projects"""
        if not self.gcp_available:
            return {'status': 'error', 'error': 'Google Cloud SDK not installed'}
        
        try:
            result = subprocess.run(
                ['gcloud', 'projects', 'list', '--format=json'],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            projects = json.loads(result.stdout) if result.stdout else []
            return {'status': 'success', 'projects': projects, 'count': len(projects)}
        except Exception as e:
            return {'status': 'error', 'error': str(e)}
    
    def check_cloud_credentials(self) -> Dict:
        """Check what cloud credentials are configured"""
        status = {
            'aws': self.aws_available,
            'azure': self.azure_available,
            'gcp': self.gcp_available
        }
        
        return {
            'status': 'success',
            'available_clouds': status,
            'configured_count': sum(status.values())
        }

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser(description="Cloud Security Testing")
    parser.add_argument('--check-creds', action='store_true', help='Check configured credentials')
    parser.add_argument('--aws-s3', action='store_true', help='Enumerate AWS S3 buckets')
    parser.add_argument('--aws-public', action='store_true', help='Check for public S3 buckets')
    parser.add_argument('--azure-resources', action='store_true', help='Enumerate Azure resources')
    parser.add_argument('--gcp-projects', action='store_true', help='Enumerate GCP projects')
    
    args = parser.parse_args()
    
    cloud = CloudExploits()
    
    if args.check_creds:
        result = cloud.check_cloud_credentials()
        print("Cloud Credentials Status:")
        for provider, available in result['available_clouds'].items():
            print(f"  {provider.upper()}: {'✅ Configured' if available else '❌ Not configured'}")
    
    if args.aws_s3:
        result = cloud.aws_enumerate_s3()
        print(f"AWS S3 Buckets: {result['status']}")
        if 'buckets' in result:
            for bucket in result['buckets']:
                print(f"  {bucket}")
    
    if args.aws_public:
        result = cloud.aws_check_public_buckets()
        print(f"Public Bucket Check: {result['status']}")
        if result.get('public_buckets'):
            print("⚠️ PUBLIC BUCKETS FOUND:")
            for bucket in result['public_buckets']:
                print(f"  {bucket}")
